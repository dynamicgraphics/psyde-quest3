<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Psyde Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <style>
        /* --- Victory & Leaderboard Screen Styling --- */
        #victory-screen, #leaderboard-screen {
            display: none; /* Hidden by default */
            flex-direction: column; justify-content: center; align-items: center;
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: #222 url('https://res.cloudinary.com/dvf40x79k/image/upload/v1708645009/dungeon_tile_bg_y3j86m.png') repeat;
            z-index: 200;
        }
        #qr-code { background-color: white; padding: 10px; margin: 20px 0; }
        #leaderboard-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            font-size: 0.8em;
        }
        #leaderboard-table th, #leaderboard-table td {
            border: 2px solid white;
            padding: 8px;
            text-align: left;
        }
        #leaderboard-table th { color: #FFFF00; }
        /* All other CSS is the same */
    </style>
</head>
<body>
    <div id="game-container">
        <div id="start-screen" class="ui-element">
            <div class="start-box">
                <h1>Psyde Quest</h1>
                <p>An adventure awaits...</p>
                <button id="start-button">Begin</button>
                <button id="leaderboard-button">Leaderboard</button>
            </div>
        </div>
        
        <div id="victory-screen" class="ui-element">
            <div class="start-box">
                <h2>Quest Complete!</h2>
                <p>Show this code to an admin to claim your prize.</p>
                <div id="qr-code"></div>
                <p id="final-time"></p>
                <button id="play-again-button">Play Again (Speed Run)</button>
            </div>
        </div>
        
        <div id="leaderboard-screen" class="ui-element">
            <div class="start-box">
                <h2>High Scores</h2>
                <table id="leaderboard-table">
                    <thead><tr><th>Rank</th><th>Time</th><th>Date</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button id="close-leaderboard-button">Back</button>
            </div>
        </div>

        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const victoryScreen = document.getElementById('victory-screen');
            const qrCodeContainer = document.getElementById('qr-code');
            const playAgainButton = document.getElementById('play-again-button');
            const finalTimeEl = document.getElementById('final-time');
            const leaderboardButton = document.getElementById('leaderboard-button');
            const leaderboardScreen = document.getElementById('leaderboard-screen');
            const closeLeaderboardButton = document.getElementById('close-leaderboard-button');
            
            // --- Game State ---
            let gameStartTime;
            let beacons = [ /* Define your 5 beacon objects here */ ];
            let currentBeaconIndex = 0;
            let beaconsCaptured = 0;
            let isSpeedRun = false;
            
            // --- Event Listeners ---
            leaderboardButton.addEventListener('click', showLeaderboard);
            closeLeaderboardButton.addEventListener('click', () => { leaderboardScreen.style.display = 'none'; });
            playAgainButton.addEventListener('click', () => {
                victoryScreen.style.display = 'none';
                isSpeedRun = true;
                resetGame();
                startGame();
            });

            function startGame() {
                // ... existing startGame logic ...
                if (!gameStartTime) gameStartTime = new Date();
                // Load the first beacon
                loadBeacon(beacons[currentBeaconIndex]);
            }

            function resetGame() {
                beaconsCaptured = 0;
                currentBeaconIndex = 0;
                gameStartTime = new Date(); // Reset timer for speed run
                sidebarSlots.forEach(slot => slot.classList.remove('captured'));
                if (isSpeedRun) {
                    // Shuffle beacons for speed run
                    beacons.sort(() => Math.random() - 0.5);
                }
            }

            function submitCode() {
                if (puzzleInput.value.toUpperCase() === beacons[currentBeaconIndex].code) {
                    // ... (update sidebar)
                    beaconsCaptured++;

                    if (beaconsCaptured >= beacons.length) {
                        // Game complete!
                        const endTime = new Date();
                        const timeTaken = (endTime - gameStartTime) / 1000; // in seconds
                        const formattedTime = new Date(timeTaken * 1000).toISOString().substr(14, 5); // MM:SS format
                        
                        showVictoryScreen(gameStartTime.getTime(), formattedTime);
                        if (isSpeedRun) saveScore(formattedTime);

                    } else {
                        currentBeaconIndex++;
                        loadBeacon(beacons[currentBeaconIndex]);
                        // ... (reset UI for next stage)
                    }
                } else { /* ... incorrect code ... */ }
            }

            function loadBeacon(beacon) {
                targetBeacon.lat = beacon.lat;
                targetBeacon.lon = beacon.lon;
                // Update AR marker info if needed
            }

            function showVictoryScreen(timestamp, formattedTime) {
                gameUi.style.display = 'none';
                victoryScreen.style.display = 'flex';
                finalTimeEl.textContent = `Final Time: ${formattedTime}`;

                // Generate QR Code
                qrCodeContainer.innerHTML = '';
                const qr = qrcode(0, 'L');
                qr.addData(`PsydeQuestClear:${timestamp}`);
                qr.make();
                qrCodeContainer.innerHTML = qr.createImgTag(4);
            }
            
            // --- Leaderboard Functions ---
            function saveScore(time) {
                const scores = JSON.parse(localStorage.getItem('psydeQuestScores')) || [];
                const newScore = {
                    time: time,
                    date: new Date().toLocaleDateString()
                };
                scores.push(newScore);
                scores.sort((a, b) => a.time.localeCompare(b.time)); // Sort by time, fastest first
                localStorage.setItem('psydeQuestScores', JSON.stringify(scores.slice(0, 5))); // Keep top 5
            }

            function showLeaderboard() {
                const scores = JSON.parse(localStorage.getItem('psydeQuestScores')) || [];
                const tableBody = leaderboardScreen.querySelector('tbody');
                tableBody.innerHTML = ''; // Clear old scores
                
                if (scores.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="3">No scores yet!</td></tr>`;
                } else {
                    scores.forEach((score, index) => {
                        const row = `<tr><td>${index + 1}</td><td>${score.time}</td><td>${score.date}</td></tr>`;
                        tableBody.innerHTML += row;
                    });
                }
                leaderboardScreen.style.display = 'flex';
            }

            // --- All other functions (AR, map, etc.) remain the same ---
        });
    </script>
    </body>
</html>
