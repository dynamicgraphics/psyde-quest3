<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Psyde Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --coin-url: url('https://cdn.jsdelivr.net/gh/dynamicgraphics/psyde-quest3@main/coin-v1.png');
            --background-url: url('https://res.cloudinary.com/dvf40x79k/image/upload/v1708645009/dungeon_tile_bg_y3j86m.png');
        }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: 'Press Start 2P', cursive; color: white;
            image-rendering: pixelated;
        }

        .hidden { display: none !important; }
        
        #game-container {
            position: relative; width: 100%; height: 100%;
            background-image: var(--background-url);
            display: flex; justify-content: center; align-items: center;
        }

        .screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            text-align: center;
        }
        
        .box {
            background-color: rgba(0,0,0,0.7);
            padding: 30px; border-radius: 10px;
        }

        #start-screen h1 { color: #FFD700; text-shadow: 2px 2px #AA5D00; }
        #start-screen img { width: 80px; margin-bottom: 20px; animation: float 6s ease-in-out infinite; }
        #start-screen p { margin: 20px 0; }
        
        #coin-container {
            width: 300px; height: 300px;
            position: relative;
        }
        #coin-outline, #coin-fill {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: var(--coin-url);
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        #coin-outline { filter: grayscale(100%) brightness(50%) opacity(0.5); }
        #coin-fill { clip-path: inset(100% 0 0 0); transition: clip-path 0.2s linear; }
        #coin-container.active { animation: active-pulse 2s infinite; }

        #instruction-text {
            position: absolute; bottom: 20px;
            width: 90%; max-width: 400px;
            background-color: rgba(0,0,0,0.8); border: 3px solid #fff;
            padding: 15px; font-size: 0.8em;
        }
        
        #victory-screen img {
            width: 200px; height: 200px;
            border: 5px solid white;
            margin-top: 20px;
        }

        button {
            background-color: #555; color: #fff; border: 3px solid #fff;
            padding: 15px 25px; font-family: 'Press Start 2P', cursive; cursor: pointer;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        @keyframes active-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        
        <div id="start-screen" class="screen">
            <div class="box">
                <img src="https://cdn.jsdelivr.net/gh/dynamicgraphics/psyde-quest3@main/coin-v1.png" alt="Quest Coin">
                <h1>Psyde Quest</h1>
                <p>Your adventure awaits...</p>
                <button id="start-button">Begin</button>
            </div>
        </div>

        <div id="game-ui" class="screen hidden">
            <div id="coin-container">
                <div id="coin-outline"></div>
                <div id="coin-fill"></div>
            </div>
            <p id="instruction-text">Initializing...</p>
        </div>
        
        <div id="victory-screen" class="screen hidden">
            <div class="box">
                <h1>VICTORY!</h1>
                <p>You found the beacon! Show this QR code to claim your prize.</p>
                <img id="qr-code" src="" alt="Prize QR Code">
            </div>
        </div>

    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const dom = {
                startScreen: document.getElementById('start-screen'),
                startButton: document.getElementById('start-button'),
                gameUi: document.getElementById('game-ui'),
                victoryScreen: document.getElementById('victory-screen'),
                instructionText: document.getElementById('instruction-text'),
                coinContainer: document.getElementById('coin-container'),
                coinFill: document.getElementById('coin-fill'),
                qrCode: document.getElementById('qr-code'),
            };

            // --- NEW: BLE Game Constants ---
            const MIN_RSSI = -100; // Signal is very weak
            const MAX_RSSI = -45;  // Signal is very strong
            const ACTIVATION_THRESHOLD = -55; // RSSI value needed to win

            // Game State
            const state = {
                gameInterval: null,
                bleDevice: null,
                lastRssi: MIN_RSSI, // Start with the weakest signal
            };
            
            // --- MODIFIED: The start button now initializes Bluetooth ---
            async function startButtonClickHandler() {
                try {
                    await initializeBluetooth();
                    startGame();
                } catch (error) {
                    console.error("Bluetooth Error:", error);
                    alert("This game requires Bluetooth to play. Please allow access and make sure it's enabled.");
                }
            }

            // --- NEW: Function to initialize Web Bluetooth ---
            async function initializeBluetooth() {
                updateInstructionText("Requesting Bluetooth access...");
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth API is not available in this browser!');
                }

                // Scan for the ESP32 beacon
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'PsydeQuest_Beacon' }], // IMPORTANT: Match this name in your ESP32 code
                    optionalServices: [], // Add any services you might need later
                });

                state.bleDevice = device;
                
                // Set up a listener for disconnection
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                updateInstructionText("Connecting to beacon...");
                const server = await device.gatt.connect();
                console.log('Connected to', server.device.name);

                // Start watching for advertisement packets to get RSSI
                await device.watchAdvertisements();
                device.addEventListener('advertisementreceived', (event) => {
                    // event.rssi contains the signal strength
                    state.lastRssi = event.rssi;
                });
            }

            function onDisconnected() {
                alert("Beacon disconnected! Please restart the game.");
                clearInterval(state.gameInterval);
                // Optionally, reset the UI to the start screen
                window.location.reload();
            }

            function startGame() {
                dom.startScreen.classList.add('hidden');
                dom.gameUi.classList.remove('hidden');
                updateInstructionText("Search for the beacon's signal...");
                // Start the game loop to update the UI
                state.gameInterval = setInterval(gameLoop, 250); // Update UI 4 times a second
            }

            // --- MODIFIED: Game loop now uses RSSI from Bluetooth ---
            function gameLoop() {
                if (!state.bleDevice) return;

                const rssi = state.lastRssi;

                // Convert RSSI to a 0-100 percentage for the meter
                let fillPercent = 100 * (rssi - MIN_RSSI) / (MAX_RSSI - MIN_RSSI);
                fillPercent = Math.max(0, Math.min(100, fillPercent)); // Clamp between 0 and 100
                
                // Update the coin fill UI
                dom.coinFill.style.clipPath = `inset(${100 - fillPercent}% 0 0 0)`;

                // Check for victory condition
                if (rssi > ACTIVATION_THRESHOLD) {
                    dom.coinContainer.classList.add('active');
                    updateInstructionText("Signal strong! You found it!");
                    clearInterval(state.gameInterval);
                    setTimeout(showVictory, 1000); // Wait a second before showing victory screen
                } else {
                    dom.coinContainer.classList.remove('active');
                    updateInstructionText("Searching for the beacon's signal...");
                }
            }

            function showVictory() {
                const prizeCode = `PsydeQuest-Winner-${Date.now()}`;
                dom.qrCode.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(prizeCode)}`;
                
                dom.gameUi.classList.add('hidden');
                dom.victoryScreen.classList.remove('hidden');
            }
            
            function updateInstructionText(message) {
                dom.instructionText.textContent = message;
            }

            dom.startButton.addEventListener('click', startButtonClickHandler);
        });
    </script>
</body>
</html>
