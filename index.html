<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Psyde Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body, html { /* ... no changes ... */ }
        #game-container { /* ... no changes ... */ }
        .screen { /* ... no changes ... */ }
        #start-screen { /* ... no changes ... */ }
        #game-screen { /* ... no changes ... */ }
        h1, p, button { /* ... no changes ... */ }

        #mini-map-container {
            position: absolute; top: 20px; left: 20px;
            width: 150px; height: 150px; /* NEW: Larger default size */
            background-color: rgba(0,0,0,0.8);
            border-radius: 50%;
            z-index: 100;
            background-image: url('data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8" ?><svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg"><circle cx="60" cy="60" r="58" stroke="white" stroke-width="4"/></svg>');
            image-rendering: pixelated;
            transition: all 0.5s ease-in-out; /* NEW: Smooth transition for resizing */
        }
        
        /* NEW: Class for the smaller map size */
        #mini-map-container.shrunk {
            width: 100px; height: 100px;
        }
        
        #player-arrow { /* ... no changes ... */ }
        #beacon-dot { /* ... no changes ... */ }
        #ring-container { /* ... no changes ... */ }
        #ring-container.active { /* ... no changes ... */ }
        @keyframes pulse { /* ... no changes ... */ }
        #instruction-text { /* ... no changes ... */ }

        /* NEW: Styling for the Scan Button */
        #scan-button {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="start-screen" class="screen">
            </div>

        <div id="game-screen" class="screen">
            <div id="mini-map-container">
                <div id="player-arrow"></div>
                <div id="beacon-dot"></div>
            </div>
            <div id="ring-container"></div>
            <p id="instruction-text">Initializing...</p>
            <button id="scan-button">Scan for Beacon</button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const scanButton = document.getElementById('scan-button');
        const miniMap = document.getElementById('mini-map-container');
        // (Other elements are the same)
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const startButton = document.getElementById('start-button');
        const playerArrow = document.getElementById('player-arrow');
        const beaconDot = document.getElementById('beacon-dot');
        const ringContainer = document.getElementById('ring-container');
        const instructionText = document.getElementById('instruction-text');
        const startPrompt = document.getElementById('start-prompt');


        // --- Game State & Beacons ---
        const BEACON_UUID = "8ec76ea3-6668-48da-9866-75be8d83f82d";
        const targetBeacon = { lat: 32.5362, lon: -97.3239 }; 
        const ACTIVATION_DISTANCE_METERS = 10; 
        let previousDistance = Infinity;

        // --- Initial Load ---
        window.addEventListener('load', checkPermissionsOnLoad);
        startButton.addEventListener('click', requestPermissionsAndStart);
        scanButton.addEventListener('click', scanForBeacon); // NEW: Event listener for scan button

        // --- Core Functions ---
        async function checkPermissionsOnLoad() { /* ... no changes ... */ }
        async function requestPermissionsAndStart() { /* ... no changes ... */ }

        function startGame() {
            startScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            updateInstructionText("Follow the red dot on your map.");
            window.addEventListener('deviceorientation', handleOrientation);
            navigator.geolocation.watchPosition(handlePositionUpdate);
        }

        function updateInstructionText(message) { /* ... no changes ... */ }
        function handleOrientation(event) { /* ... no changes ... */ }

        function handlePositionUpdate(position) {
            const playerLat = position.coords.latitude;
            const playerLon = position.coords.longitude;
            const distance = getDistance(playerLat, playerLon, targetBeacon.lat, targetBeacon.lon);
            
            if (distance <= ACTIVATION_DISTANCE_METERS) {
                ringContainer.classList.add('active');
                miniMap.classList.add('shrunk'); // Shrink map
                scanButton.style.display = 'block'; // Show scan button
                updateInstructionText("You're close! Press SCAN!");
            } else {
                ringContainer.classList.remove('active');
                miniMap.classList.remove('shrunk'); // Enlarge map
                scanButton.style.display = 'none'; // Hide scan button
                
                // NEW: Jitter threshold added
                if (previousDistance - distance > 2) { // Moved more than 2m closer
                    updateInstructionText("You're getting warmer...");
                } else if (distance - previousDistance > 2) { // Moved more than 2m farther
                    updateInstructionText("Getting colder... Turn back!");
                }
            }
            previousDistance = distance;
            updateBeaconDot(playerLat, playerLon, targetBeacon.lat, targetBeacon.lon);
        }

        // --- NEW: Web Bluetooth Scan Function ---
        async function scanForBeacon() {
            if (!navigator.bluetooth) {
                alert("Web Bluetooth is not available on this device!");
                return;
            }
            
            try {
                updateInstructionText("Searching for beacon signal...");
                
                // Request a device that is advertising the specific service UUID
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BEACON_UUID] }]
                });

                updateInstructionText("Beacon Found! Quest Complete!");
                navigator.vibrate(200); // Haptic feedback!
                ringContainer.style.borderColor = '#00FF00'; // Turn ring green for success
                scanButton.style.display = 'none'; // Hide button after finding
                // We'll add logic here later to advance to the next stage

            } catch (error) {
                console.error("Scan failed:", error);
                updateInstructionText("Scan failed. Try again!");
            }
        }
        
        function updateBeaconDot(playerLat, playerLon, beaconLat, beaconLon) { /* ... no changes ... */ }
        function getDistance(lat1, lon1, lat2, lon2) { /* ... no changes ... */ }
        function getBearing(lat1, lon1, lat2, lon2) { /* ... no changes ... */ }

    </script>
</body>
</html>
